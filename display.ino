#define ModuleQty 8
#define ModuleColQty 4
#define ModuleRowQty 2
#define displayDebug false

LedControl led = LedControl(displayDataInPin,displayClkPin,displayLoadPin1,displayLoadPin2,ModuleQty);
bool displayOn = false;

// Structure pour définir les polices de caractères
struct font1Struct { char key; uint8_t width; byte pixelLines[7]; };
struct font2Struct { char key; uint8_t width; uint8_t pixelLines[12]; };
struct font3Struct { char key; uint8_t width; uint16_t pixelLines[15]; };
struct font4Struct { char key; uint8_t width; uint16_t pixelLines[15]; };
struct font5Struct { char key; uint8_t width; uint16_t pixelLines[15]; };
struct font99Struct { char key; uint8_t width; uint32_t pixelLines[16]; };

// Table ASCII 5x7 standard (caractères 32 → 122)
#define font1_char_count 91
const font1Struct font1_chars[font1_char_count] PROGMEM = {
  {' ',3,{0b000,0b000,0b000,0b000,0b000,0b000,0b000}},
  {'"',3,{0b101,0b101,0b000,0b000,0b000,0b000,0b000}},
  {'#',5,{0b00000,0b01010,0b11111,0b01010,0b11111,0b01010,0b00000}},
  {'$',5,{0b01111,0b10100,0b10100,0b01110,0b00101,0b00101,0b11110}},
  {'%',5,{0b11000,0b11001,0b00010,0b00100,0b01000,0b10011,0b00011}},
  {'&',5,{0b01100,0b10010,0b10010,0b01101,0b10010,0b10010,0b01101}},
  {'\'',1,{0b1,0b1,0b0,0b0,0b0,0b0,0b0}},
  {'(',3,{0b001,0b010,0b010,0b010,0b010,0b010,0b001}},
  {')',3,{0b100,0b010,0b010,0b010,0b010,0b010,0b100}},
  {'*',4,{0b0000,0b0000,0b1010,0b0100,0b1010,0b0000,0b0000}},
  {'+',3,{0b000,0b000,0b010,0b111,0b010,0b000,0b000}},
  {',',3,{0b000,0b000,0b000,0b000,0b010,0b010,0b100}},
  {'-',3,{0b000,0b000,0b000,0b111,0b000,0b000,0b000}},
  {'.',3,{0b000,0b000,0b000,0b000,0b000,0b000,0b010}},
  {'/',5,{0b00000,0b00001,0b00010,0b00100,0b01000,0b10000,0b00000}},
  {'0',5,{0b01110,0b10001,0b10011,0b10101,0b11001,0b10001,0b01110}},
  {'1',3,{0b010,0b110,0b010,0b010,0b010,0b010,0b111}},
  {'2',5,{0b01110,0b10001,0b00001,0b00110,0b01000,0b10000,0b11111}},
  {'3',5,{0b01110,0b10001,0b00001,0b00110,0b00001,0b10001,0b01110}},
  {'4',5,{0b00010,0b00110,0b01010,0b10010,0b11111,0b00010,0b00010}},
  {'5',5,{0b11111,0b10000,0b11110,0b00001,0b00001,0b10001,0b01110}},
  {'6',5,{0b01110,0b10001,0b10000,0b11110,0b10001,0b10001,0b01110}},
  {'7',5,{0b11111,0b00001,0b00010,0b00100,0b01000,0b01000,0b01000}},
  {'8',5,{0b01110,0b10001,0b10001,0b01110,0b10001,0b10001,0b01110}},
  {'9',5,{0b01110,0b10001,0b10001,0b01111,0b00001,0b10001,0b01110}},
  {':',3,{0b000,0b000,0b010,0b000,0b010,0b000,0b000}},
  {';',3,{0b000,0b000,0b000,0b010,0b000,0b010,0b100}},
  {'<',4,{0b0000,0b0010,0b0100,0b1000,0b0100,0b0010,0b0000}},
  {'=',3,{0b000,0b000,0b111,0b000,0b111,0b000,0b000}},
  {'>',4,{0b0000,0b1000,0b0100,0b0010,0b0100,0b1000,0b0000}},
  {'?',5,{0b01110,0b10001,0b00001,0b00010,0b00100,0b00000,0b00100}},
  {'@',5,{0b01110,0b10001,0b10011,0b10101,0b10011,0b10000,0b01111}},
  {'A',5,{0b00100,0b01010,0b10001,0b11111,0b10001,0b10001,0b10001}},
  {'B',5,{0b11110,0b10001,0b10001,0b11110,0b10001,0b10001,0b11110}},
  {'C',5,{0b01110,0b10001,0b10000,0b10000,0b10000,0b10001,0b01110}},
  {'D',5,{0b11110,0b10001,0b10001,0b10001,0b10001,0b10001,0b11110}},
  {'E',5,{0b11111,0b10000,0b10000,0b11110,0b10000,0b10000,0b11111}},
  {'F',5,{0b11111,0b10000,0b10000,0b11110,0b10000,0b10000,0b10000}},
  {'G',5,{0b01110,0b10001,0b10000,0b10110,0b10001,0b10001,0b01110}},
  {'H',5,{0b10001,0b10001,0b10001,0b11111,0b10001,0b10001,0b10001}},
  {'I',3,{0b111,0b010,0b010,0b010,0b010,0b010,0b111}},
  {'J',5,{0b01111,0b00001,0b00001,0b00001,0b10001,0b10001,0b01110}},
  {'K',5,{0b10001,0b10010,0b10100,0b11000,0b10100,0b10010,0b10001}},
  {'L',5,{0b10000,0b10000,0b10000,0b10000,0b10000,0b10000,0b11111}},
  {'M',5,{0b10001,0b11011,0b10101,0b10001,0b10001,0b10001,0b10001}},
  {'N',5,{0b10001,0b10001,0b11001,0b10101,0b10011,0b10001,0b10001}},
  {'O',5,{0b01110,0b10001,0b10001,0b10001,0b10001,0b10001,0b01110}},
  {'P',5,{0b11110,0b10001,0b10001,0b11110,0b10000,0b10000,0b10000}},
  {'Q',5,{0b01110,0b10001,0b10001,0b10001,0b10101,0b10010,0b01101}},
  {'R',5,{0b11110,0b10001,0b10001,0b11110,0b10001,0b10001,0b10001}},
  {'S',5,{0b01110,0b10001,0b10000,0b01110,0b00001,0b10001,0b01110}},
  {'T',5,{0b11111,0b00100,0b00100,0b00100,0b00100,0b00100,0b00100}},
  {'U',5,{0b10001,0b10001,0b10001,0b10001,0b10001,0b10001,0b01110}},
  {'V',5,{0b10001,0b10001,0b10001,0b10001,0b10001,0b01010,0b00100}},
  {'W',5,{0b10001,0b10001,0b10001,0b10001,0b10101,0b10101,0b01010}},
  {'X',5,{0b10001,0b10001,0b01010,0b00100,0b01010,0b10001,0b10001}},
  {'Y',5,{0b10001,0b10001,0b01010,0b00100,0b00100,0b00100,0b00100}},
  {'Z',5,{0b11111,0b00001,0b00010,0b00100,0b01000,0b10000,0b11111}},
  {'[',2,{0b11,0b10,0b10,0b10,0b10,0b10,0b11}},
  {'\\',5,{0b00000,0b10000,0b01000,0b00100,0b00010,0b00001,0b00000}},
  {']',2,{0b11,0b01,0b01,0b01,0b01,0b01,0b11}},
  {'^',5,{0b00100,0b01010,0b10001,0b00000,0b00000,0b00000,0b00000}},
  {'_',5,{0b00000,0b00000,0b00000,0b00000,0b00000,0b00000,0b11111}},
  {'`',3,{0b100,0b010,0b000,0b000,0b000,0b000,0b000}},
  {'a',4,{0b0000,0b0000,0b0110,0b0001,0b0111,0b1001,0b0111}},
  {'b',4,{0b1000,0b1000,0b1000,0b1110,0b1001,0b1001,0b1110}},
  {'c',4,{0b0000,0b0000,0b0110,0b1001,0b1000,0b1001,0b0110}},
  {'d',4,{0b0001,0b0001,0b0001,0b0111,0b1001,0b1001,0b0111}},
  {'e',4,{0b0000,0b0000,0b0110,0b1001,0b1111,0b1000,0b0110}},
  {'f',3,{0b011,0b100,0b100,0b111,0b100,0b100,0b100}},
  {'g',4,{0b0000,0b0111,0b1001,0b1001,0b0111,0b0001,0b0110}},
  {'h',4,{0b1000,0b1000,0b1000,0b1110,0b1001,0b1001,0b1001}},
  {'i',1,{0b1,0b0,0b0,0b1,0b1,0b1,0b1}},
  {'j',3,{0b010,0b000,0b010,0b010,0b010,0b010,0b100}},
  {'k',4,{0b1000,0b1001,0b1010,0b1100,0b1010,0b1001,0b1001}},
  {'l',1,{0b1,0b1,0b1,0b1,0b1,0b1,0b1}},
  {'m',5,{0b00000,0b00000,0b11110,0b10101,0b10101,0b10101,0b10101}},
  {'n',4,{0b0000,0b0000,0b1110,0b1001,0b1001,0b1001,0b1001}},
  {'o',4,{0b0000,0b0000,0b0110,0b1001,0b1001,0b1001,0b0110}},
  {'p',4,{0b0000,0b0110,0b1001,0b1001,0b1110,0b1000,0b1000}},
  {'q',4,{0b0000,0b0110,0b1001,0b1001,0b0111,0b0001,0b0001}},
  {'r',4,{0b0000,0b0000,0b1011,0b1100,0b1000,0b1000,0b1000}},
  {'s',4,{0b0000,0b0000,0b0111,0b1000,0b0110,0b0001,0b1110}},
  {'t',4,{0b0100,0b0100,0b1111,0b0100,0b0100,0b0100,0b0011}},
  {'u',4,{0b0000,0b0000,0b1001,0b1001,0b1001,0b1001,0b0111}},
  {'v',5,{0b00000,0b00000,0b10001,0b10001,0b10001,0b01010,0b00100}},
  {'w',5,{0b00000,0b00000,0b10001,0b10001,0b10101,0b10101,0b01010}},
  {'x',4,{0b0000,0b0000,0b1001,0b1001,0b0110,0b1001,0b1001}},
  {'y',4,{0b0000,0b0000,0b1001,0b1001,0b0111,0b0001,0b0110}},
  {'z',4,{0b0000,0b0000,0b1111,0b0001,0b0110,0b1000,0b1111}}
};
// Police 5x12 pixels 
#define font2_char_count 11
const font2Struct font2_chars[font2_char_count] PROGMEM = {
  {'0',4,{0b0110,0b1111,0b1001,0b1001,0b1001,0b1001,0b1001,0b1001,0b1001,0b1001,0b1111,0b0110}},
  {'1',5,{0b00100,0b01100,0b11100,0b00100,0b00100,0b00100,0b00100,0b00100,0b00100,0b00100,0b00100,0b11111}},
  {'2',5,{0b11110,0b11111,0b00001,0b00001,0b00011,0b00110,0b01100,0b11000,0b10000,0b10000,0b11111,0b11111}},
  {'3',6,{0b11110,0b11111,0b00001,0b00001,0b00001,0b11110,0b11110,0b00001,0b00001,0b00001,0b11111,0b11111}},
  {'4',4,{0b1001,0b1001,0b1001,0b1001,0b1001,0b1111,0b1111,0b0001,0b0001,0b0001,0b0001,0b0001}},
  {'5',5,{0b11111,0b11111,0b10000,0b10000,0b10000,0b11111,0b11111,0b00001,0b00001,0b00001,0b11111,0b11111}},
  {'6',5,{0b01110,0b11111,0b10000,0b10000,0b10000,0b11110,0b11111,0b10001,0b10001,0b10001,0b11111,0b01110}},
  {'7',5,{0b11111,0b11111,0b10001,0b10001,0b00001,0b00001,0b00001,0b00001,0b00001,0b00001,0b00001,0b00001}},
  {'8',5,{0b01110,0b11111,0b10001,0b10001,0b10001,0b11111,0b11111,0b10001,0b10001,0b10001,0b11111,0b01110}},
  {'9',5,{0b01110,0b11111,0b10001,0b10001,0b10001,0b11111,0b11111,0b00001,0b00001,0b00001,0b11111,0b01110}},
  {'*',7,{0b0000000,0b0011100,0b0100010,0b1000001,0b1010101,0b1000001,0b1010101,0b1001001,0b0100010,0b0011100,0b0000000,0b0000000}},
};

// Police 6x15 pixels 
#define font3_char_count 11
const font3Struct font3_chars[font3_char_count] PROGMEM = {
  {'0',6,{0b011110,0b111111,0b111111,0b110011,0b110011,0b110011,0b110011,0b110011,0b110011,0b110011,0b110011,0b110011,0b111111,0b111111,0b011110}},
  {'1',6,{0b001100,0b011100,0b111100,0b111100,0b001100,0b001100,0b001100,0b001100,0b001100,0b001100,0b001100,0b001100,0b111111,0b111111,0b111111}},
  {'2',6,{0b111110,0b111111,0b111111,0b000011,0b000011,0b000011,0b011111,0b111111,0b111110,0b110000,0b110000,0b110000,0b111111,0b111111,0b111111}},
  {'3',6,{0b111110,0b111111,0b111111,0b000011,0b000011,0b000011,0b111111,0b111110,0b111111,0b000011,0b000011,0b000011,0b111111,0b111111,0b111110}},
  {'4',6,{0b110011,0b110011,0b110011,0b110011,0b110011,0b110011,0b111111,0b111111,0b011111,0b000011,0b000011,0b000011,0b000011,0b000011,0b000011}},
  {'5',6,{0b111111,0b111111,0b111111,0b110000,0b110000,0b110000,0b111110,0b111111,0b011111,0b000011,0b000011,0b000011,0b111111,0b111111,0b111110}},
  {'6',6,{0b011110,0b111111,0b111111,0b110000,0b110000,0b110000,0b111110,0b111111,0b111111,0b110011,0b110011,0b110011,0b111111,0b111111,0b011110}},
  {'7',6,{0b111111,0b111111,0b111111,0b110011,0b110011,0b000011,0b000011,0b000011,0b000011,0b000011,0b000011,0b000011,0b000011,0b000011,0b000011}},
  {'8',6,{0b011110,0b111111,0b111111,0b110011,0b110011,0b110011,0b111111,0b011110,0b111111,0b110011,0b110011,0b110011,0b111111,0b111111,0b011110}},
  {'9',6,{0b011110,0b111111,0b111111,0b110011,0b110011,0b110011,0b111111,0b111111,0b011111,0b000011,0b000011,0b000011,0b111111,0b111111,0b111110}},
  {'*',9,{0b000000000,0b000000000,0b000000000,0b001111100,0b010000010,0b101101101,0b101101101,0b100000001,0b101000101,0b100111001,0b010000010,0b001111100,0b000000000,0b000000000,0b000000000}},
};

// Police 8x15 pixels 
#define font4_char_count 11
const font4Struct font4_chars[font4_char_count] PROGMEM = {
  {'0',8,{0b01111110,0b11111111,0b11111111,0b11100111,0b11100111,0b11100111,0b11100111,0b11100111,0b11100111,0b11100111,0b11100111,0b11100111,0b11111111,0b11111111,0b01111110}},
  {'1',7,{0b0011100,0b0111100,0b1111100,0b1111100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b1111111,0b1111111,0b1111111}},
  {'2',8,{0b11111110,0b11111111,0b11111111,0b00000111,0b00000111,0b00000111,0b01111111,0b11111111,0b11111110,0b11100000,0b11100000,0b11100000,0b11111111,0b11111111,0b11111111}},
  {'3',8,{0b11111110,0b11111111,0b11111111,0b00000111,0b00000111,0b00000111,0b11111111,0b11111110,0b11111111,0b00000111,0b00000111,0b00000111,0b11111111,0b11111111,0b11111110}},
  {'4',8,{0b11100111,0b11100111,0b11100111,0b11100111,0b11100111,0b11100111,0b11111111,0b11111111,0b01111111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111}},
  {'5',8,{0b11111111,0b11111111,0b11111111,0b11100000,0b11100000,0b11100000,0b11111110,0b11111111,0b01111111,0b00000111,0b00000111,0b00000111,0b11111111,0b11111111,0b11111110}},
  {'6',8,{0b01111110,0b11111111,0b11111111,0b11100000,0b11100000,0b11100000,0b11111110,0b11111111,0b11111111,0b11100111,0b11100111,0b11100111,0b11111111,0b11111111,0b01111110}},
  {'7',8,{0b11111111,0b11111111,0b11111111,0b11000111,0b11000111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111,0b00000111}},
  {'8',8,{0b01111110,0b11111111,0b11111111,0b11100111,0b11100111,0b11100111,0b11111111,0b01111110,0b11111111,0b11100111,0b11100111,0b11100111,0b11111111,0b11111111,0b01111110}},
  {'9',8,{0b01111110,0b11111111,0b11111111,0b11100111,0b11100111,0b11100111,0b11111111,0b11111111,0b01111111,0b00000111,0b00000111,0b00000111,0b11111111,0b11111111,0b11111110}},
  {'*',11,{0b00000000000,0b00000000000,0b00011111000,0b00100000100,0b01000000010,0b10011011001,0b10011011001,0b10000000001,0b10000000001,0b10010001001,0b10001110001,0b01000000010,0b00100000100,0b00011111000,0b00000000000}}
};

// Police 9x15 pixels 
#define font5_char_count 11
const font5Struct font5_chars[font5_char_count] PROGMEM = {
  {'0',9,{0b011111110,0b111111111,0b111111111,0b111000111,0b111000111,0b111000111,0b111000111,0b111000111,0b111000111,0b111000111,0b111000111,0b111000111,0b111111111,0b111111111,0b011111110}},
  {'1',7,{0b0011100,0b0111100,0b1111100,0b1111100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b0011100,0b1111111,0b1111111,0b1111111}},
  {'2',9,{0b111111110,0b111111111,0b111111111,0b000000111,0b000000111,0b000000111,0b011111111,0b111111111,0b111111110,0b111000000,0b111000000,0b111000000,0b111111111,0b111111111,0b111111111}},
  {'3',9,{0b111111110,0b111111111,0b111111111,0b000000111,0b000000111,0b000000111,0b111111111,0b111111110,0b111111111,0b000000111,0b000000111,0b000000111,0b111111111,0b111111111,0b111111110}},
  {'4',9,{0b111000111,0b111000111,0b111000111,0b111000111,0b111000111,0b111000111,0b111111111,0b111111111,0b011111111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111}},
  {'5',9,{0b111111111,0b111111111,0b111111111,0b111000000,0b111000000,0b111000000,0b111111110,0b111111111,0b011111111,0b000000111,0b000000111,0b000000111,0b111111111,0b111111111,0b111111110}},
  {'6',9,{0b011111110,0b111111111,0b111111111,0b111000000,0b111000000,0b111000000,0b111111110,0b111111111,0b111111111,0b111000111,0b111000111,0b111000111,0b111111111,0b111111111,0b011111110}},
  {'7',9,{0b111111111,0b111111111,0b111111111,0b111000111,0b111000111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111,0b000000111}},
  {'8',9,{0b011111110,0b111111111,0b111111111,0b111000111,0b111000111,0b111000111,0b111111111,0b011111110,0b111111111,0b111000111,0b111000111,0b111000111,0b111111111,0b111111111,0b011111110}},
  {'9',9,{0b011111110,0b111111111,0b111111111,0b111000111,0b111000111,0b111000111,0b111111111,0b111111111,0b011111111,0b000000111,0b000000111,0b000000111,0b111111111,0b111111111,0b111111110}}, 
  {'*',12,{0b000000000000,0b000011110000,0b000100001000,0b001000000100,0b010000000010,0b100110011001,0b100110011001,0b100000000001,0b100000000001,0b100010010001,0b010001100010,0b001000000100,0b000100001000,0b000011110000,0b000000000000}}
};

// Animation plein écran 32x16 pixels
#define font99_char_count 7
const font99Struct font99_chars[font99_char_count] PROGMEM = { 
{'1',32,{0b10000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b10000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000}},
{'2',32,{0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000}},
{'3',32,{0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000}},
{'4',32,{0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000000000}},
{'5',32,{0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111,0b11111111111111111111111111111111}},

  {'+',32,{0b00000000000111111111000000000000,0b00000000011000000000110000000000,0b00000000100000000000001000000000,0b00000000100000000110001000000000,0b00000001000000001110000100000000,0b00000001000110000110000100000000,0b00000010000110000110000010000000,0b00000010011111100110000010000000,0b00000010011111100110000010000000,0b00000010000110000110000010000000,0b00000001000110000110000100000000,0b00000001000000000110000100000000,0b00000000100000001111001000000000,0b00000000100000000000001000000000,0b00000000011000000000110000000000,0b00000000000111111111000000000000}},
  {'-',32,{0b00000000011111000001111100000000,0b00000000111111100011111110000000,0b00000001111111110111111111000000,0b00000001111111111111111111000000,0b00000001111100011011111111000000,0b00000001111011101011011111000000,0b00000001111011101010111111000000,0b00000000111011101001111110000000,0b00000000111011101010111110000000,0b00000000011011101011011100000000,0b00000000001100011011011000000000,0b00000000000111111111110000000000,0b00000000000011111111100000000000,0b00000000000001111111000000000000,0b00000000000000111110000000000000,0b00000000000000011100000000000000}}
};

// Définitions des polices
const FontDefStruct font1 = { 7, 1, font1_char_count, font1_chars};
const FontDefStruct font2 = { 12, 1, font2_char_count, font2_chars};
const FontDefStruct font3 = { 15, 1, font3_char_count, font3_chars};
const FontDefStruct font4 = { 15, 2, font4_char_count, font4_chars};
const FontDefStruct font5 = { 15, 5, font5_char_count, font5_chars};
const FontDefStruct font99 = { 16, 0, font99_char_count, font99_chars};

int fontGetCharId(const FontDefStruct* fontDef, char key) {
  if(fontDef == &font1) { const font1Struct* f = (const font1Struct*)fontDef->fontData; for (int i = 0; i < fontDef->charCount; i++) { if (pgm_read_byte(&(f[i].key)) == key) { return i; } } }
  if(fontDef == &font2) { const font2Struct* f = (const font2Struct*)fontDef->fontData; for (int i = 0; i < fontDef->charCount; i++) { if (pgm_read_byte(&(f[i].key)) == key) { return i; } } }
  if(fontDef == &font3) { const font3Struct* f = (const font3Struct*)fontDef->fontData; for (int i = 0; i < fontDef->charCount; i++) { if (pgm_read_byte(&(f[i].key)) == key) { return i; } } }
  if(fontDef == &font4) { const font4Struct* f = (const font4Struct*)fontDef->fontData; for (int i = 0; i < fontDef->charCount; i++) { if (pgm_read_byte(&(f[i].key)) == key) { return i; } } }
  if(fontDef == &font5) { const font5Struct* f = (const font5Struct*)fontDef->fontData; for (int i = 0; i < fontDef->charCount; i++) { if (pgm_read_byte(&(f[i].key)) == key) { return i; } } }
  if(fontDef == &font99) { const font99Struct* f = (const font99Struct*)fontDef->fontData; for (int i = 0; i < fontDef->charCount; i++) { if (pgm_read_byte(&(f[i].key)) == key) { return i; } } }
  return -1; // Clé non trouvée
}

int fontGetWidth(const FontDefStruct* fontDef, char key) {
  int carId = fontGetCharId(fontDef, key);
  if(carId == -1) { return 0; }
  if(fontDef == &font1) { return pgm_read_byte(&(((font1Struct*)fontDef->fontData)[carId].width)); }
  if(fontDef == &font2) { return pgm_read_byte(&(((font2Struct*)fontDef->fontData)[carId].width)); }
  if(fontDef == &font3) { return pgm_read_byte(&(((font3Struct*)fontDef->fontData)[carId].width)); }
  if(fontDef == &font4) { return pgm_read_byte(&(((font4Struct*)fontDef->fontData)[carId].width)); }
  if(fontDef == &font5) { return pgm_read_byte(&(((font5Struct*)fontDef->fontData)[carId].width)); }
  if(fontDef == &font99) { return pgm_read_byte(&(((font99Struct*)fontDef->fontData)[carId].width)); }
  return 0;
}

void displayInit() {
  for (int moduleAddr = 0; moduleAddr < ModuleQty; moduleAddr++) {
    led.shutdown(moduleAddr,false);
    led.setIntensity(moduleAddr,15);
    led.clearDisplay(moduleAddr);
  };
  displayOn = true;
  displayShowMonoLine("START");
  debugTrace("Event","Display initialisation OK");
  watchDogReset();
}

uint32_t displayCounterOffUntil = 0;
String displayedLine1 = "";
String displayedLine2 = "";
const FontDefStruct* defaultFont = &font1;

void displayShow2Lines(String line1, String line2, int duration) {
// Vérification que l'affichage est actif
  if(!displayOn) { return; }
// Cache 
  if((displayedLine1 == line1)&&(displayedLine2 == line2)) { return; }
  displayedLine1 = line1; displayedLine2 = line2;
// Temporisation de l'affichage du compteur
  if(duration>0) { displayCounterOffUntil = millis()+1000*duration ; }  
// Définition de la police
  int linesCount = 2; 
  const FontDefStruct* fontDef = &font1;
  if(line2=="") { 
    linesCount = 1; 
    fontDef = defaultFont;
  }
// Décomposition de la chaîne de caractères
  int stringlength = max(line1.length(),line2.length());
  int matrixWidth = (ModuleColQty*8);
  int matrixHeight = (ModuleRowQty*8);
// Composition binaire de la surface écran  
  bool view[matrixWidth][matrixHeight] = {{ false }};
  memset(view, 0, sizeof(view));
  bool pixel = false;
  String lineText = "";
  char car;
  int carId = 0;
  int font_width = 0;
  for (int line=1; line <= linesCount; line++) {
    if (line == 1) { lineText = line1; }
    if (line == 2) { lineText = line2; }
    // Alignement vertical
    int yOffset = (line-1)*(fontDef->height+1) + floor((16-(linesCount*(fontDef->height+1)))/(1+linesCount));
    // Alignement horizontal
    int lineLength = 0;
    for (int c = 0; c < lineText.length(); c++) {
      if(c!=0) { lineLength+=fontDef->space; };
      lineLength+=fontGetWidth(fontDef,lineText.charAt(c));
    };  
    int xOffset = (int)((matrixWidth-lineLength)/2);
    if (xOffset<0) { xOffset = 0; };
    // ******
    for (int c = 0; c < lineText.length(); c++) {
      char car = lineText.charAt(c);   // extrait le i-ème caractère
      carId=fontGetCharId(fontDef,car); 
      if(carId==-1) { continue; };
      font_width = fontGetWidth(fontDef,car);
      for (int y = 0; y < fontDef->height; y++) {
        for (int x = 0; x < font_width; x++) {
          if(fontDef == &font1) { pixel = bitRead(pgm_read_byte(&(((font1Struct*)fontDef->fontData)[carId].pixelLines[y])),(font_width-1)-x); }
          if(fontDef == &font2) { pixel = bitRead(pgm_read_byte(&(((font2Struct*)fontDef->fontData)[carId].pixelLines[y])),(font_width-1)-x); }
          if(fontDef == &font3) { pixel = bitRead(pgm_read_word(&(((font3Struct*)fontDef->fontData)[carId].pixelLines[y])),(font_width-1)-x); }
          if(fontDef == &font4) { pixel = bitRead(pgm_read_word(&(((font4Struct*)fontDef->fontData)[carId].pixelLines[y])),(font_width-1)-x); }
		      if(fontDef == &font5) { pixel = bitRead(pgm_read_word(&(((font5Struct*)fontDef->fontData)[carId].pixelLines[y])),(font_width-1)-x); }
          if(fontDef == &font99) { pixel = bitRead(pgm_read_dword(&(((font99Struct*)fontDef->fontData)[carId].pixelLines[y])),(font_width-1)-x); }
          if((xOffset + x < matrixWidth)&&(yOffset + y < matrixHeight)) { view[xOffset + x][yOffset + y] = pixel; }
      } }
      xOffset+= font_width + fontDef->space;
  } }
  if(displayDebug) {
    for (int y = 0; y < matrixHeight; y++) {
      for (int x = 0; x < matrixWidth; x++) {
        if(view[x][y]) { Serial.print("x"); } else { Serial.print(" "); };
      }
      debugTrace("Event","");
  } }
// Envoi de la vue à l'écran
  for (int row = 0; row < ModuleRowQty ; row++) {
    for (int col = 0; col < ModuleColQty; col++) {
      int module = row * ModuleColQty + col;
      for (int line = 0; line < 8; line++) {
        byte byteToShow = 0;
        for(byte i = 0; i < 8; i++) { 
          // Rotation de 180° : inversion des coordonnées x et y
          int view_x = (matrixWidth - 1) - (col * 8 + i);
          int view_y = (matrixHeight - 1) - ((7 - line) + row * 8);
          byteToShow |= (view[view_x][view_y] << i); 
        }
        led.setRow(module, line, byteToShow);
} } } }

void displayShowMonoLine (String line1, int duration) {
  displayShow2Lines(line1, "", duration);
}

void displayCounter() {
  if(millis()<displayCounterOffUntil) { return; }
  int counterInt = counterToDisplay();
  if(counterInt == 0) { 
    defaultFont = &font5; displayShowMonoLine("0");
  } else if(counterInt<=9) { 
    defaultFont = &font5; displayShowMonoLine("*" + String(counterInt));
  } else if(counterInt<=99) { 
    defaultFont = &font4; displayShowMonoLine("*" + String(counterInt));
  } else if(counterInt<=999) { 
    defaultFont = &font3; displayShowMonoLine("*" + String(counterInt));
  } else if(counterInt<=9999) { 
    defaultFont = &font3; displayShowMonoLine(String(counterInt));
  } else {
    defaultFont = &font2; displayShowMonoLine(String(counterInt));
} }

void displayPlusOne() {
  displayCounterOffUntil = millis()+2000 ; 
  defaultFont = &font99;
  displayShowMonoLine("+");
}

void displayAlreadyDone() {
  displayCounterOffUntil = millis()+2000 ; 
  defaultFont = &font99;
  displayShowMonoLine("-");
}

void displaytest99() {
  displayTurnOff();
  delay(5000);
  displayTurnOn();
  watchDogReset();
  for (int i = 1; i <=5; i++) {
    defaultFont = &font99;
    debugTrace("Test","Display test "+String(i));
    displayShowMonoLine(String(i));
    delay(5000);
    watchDogReset();
  };
}

void displayTurnOff() {
  displayOn = false;
  for (int moduleAddr = 0; moduleAddr < ModuleQty; moduleAddr++) {
    led.shutdown(moduleAddr,false);
    led.clearDisplay(moduleAddr);
} }
void displayTurnOn() {
  displayOn = true;
}

// ** Fonction test ****************** 
void displayTest() {
  for (int module = (ModuleQty-1); module >=0 ; module--) { led.clearDisplay(module); }
  for (int module = (ModuleQty-1); module >=0 ; module--) {
    for (int line = 0; line < 8; line++) { led.setRow(module,line,255); delay(200); } 
    watchDogReset();
  } delay(1000);
}